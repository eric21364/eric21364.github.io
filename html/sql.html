<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Table & View é‡å»ºå·¥å…· (ç²¾æº–æ§åˆ¶ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f1f5f9; }
        .sql-output { font-family: 'Consolas', 'Monaco', monospace; white-space: pre; font-size: 13px; line-height: 1.5; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body>

<div id="app" class="container mx-auto p-4 max-w-7xl">
    
    <div class="mb-6 flex justify-between items-end border-b pb-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">ğŸ› ï¸ SQL é‡å»ºå·¥å…· <span class="text-sm font-normal text-slate-500 ml-2">v3.0</span></h1>
            <p class="text-slate-500 text-sm mt-1">ç²¾æº–æ§åˆ¶ Null å±¬æ€§è®Šæ›´ â€¢ View è‡ªå‹•é‡å»ºæµç¨‹</p>
        </div>
        <div class="flex bg-gray-200 p-1 rounded-lg">
            <button @click="mode = 'create'" :class="mode === 'create' ? 'bg-white shadow text-blue-600' : 'text-gray-600'" class="px-4 py-2 rounded-md font-bold transition">å»ºç«‹ (Create)</button>
            <button @click="mode = 'alter'" :class="mode === 'alter' ? 'bg-white shadow text-purple-600' : 'text-gray-600'" class="px-4 py-2 rounded-md font-bold transition">ä¿®æ”¹ (Alter)</button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
        
        <div class="xl:col-span-7 space-y-6">
            
            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">è³‡æ–™åº«é¡å‹</label>
                        <select v-model="dbType" class="w-full border-gray-300 border rounded-md p-2 bg-slate-50 focus:ring-2 focus:ring-blue-500">
                            <option value="pgsql">PostgreSQL</option>
                            <option value="mysql">MySQL / MariaDB</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Table Name</label>
                        <input type="text" v-model="tableName" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-blue-500" placeholder="e.g. users">
                    </div>
                </div>

                <div v-if="mode === 'alter'" class="mt-4 pt-4 border-t border-gray-100">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" v-model="alterType" value="ADD" class="mr-2"> <span class="text-sm font-medium">æ–°å¢</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" v-model="alterType" value="MODIFY" class="mr-2"> <span class="text-sm font-medium">ä¿®æ”¹ (Type)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" v-model="alterType" value="DROP" class="mr-2 text-red-600"> <span class="text-sm font-medium text-red-600">åˆªé™¤</span>
                            </label>
                        </div>

                        <div v-if="alterType === 'MODIFY'" class="flex items-center bg-blue-50 px-3 py-1 rounded border border-blue-100">
                            <label class="flex items-center cursor-pointer text-sm font-bold text-blue-700 select-none">
                                <input type="checkbox" v-model="updateNull" class="mr-2 w-4 h-4 text-blue-600 rounded">
                                åŒæ™‚ä¿®æ”¹ Null å±¬æ€§
                            </label>
                        </div>
                    </div>
                    
                    <div v-if="alterType === 'MODIFY' && dbType === 'mysql' && !updateNull" class="mt-2 text-xs text-orange-500">
                        * MySQL æç¤ºï¼šç”±æ–¼ MySQL èªæ³•ç‰¹æ€§ï¼Œå³ä½¿ä¸å‹¾é¸ã€ŒåŒæ™‚ä¿®æ”¹ã€ï¼Œé‡æ–°å®šç¾©æ¬„ä½æ™‚è‹¥æœªæŒ‡å®š NOT NULL å‰‡æœƒé è¨­ç‚º NULLã€‚
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider">
                        {{ mode === 'create' ? 'æ¬„ä½å®šç¾©' : 'ç›®æ¨™æ¬„ä½' }}
                    </h2>
                    <button v-if="mode === 'create'" @click="addColumn" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 font-bold">
                        + æ–°å¢æ¬„ä½
                    </button>
                </div>

                <div class="space-y-3">
                    <div v-for="(col, index) in columns" :key="index" class="flex flex-wrap md:flex-nowrap gap-2 items-start bg-slate-50 p-3 rounded border border-slate-200">
                        
                        <div class="w-full md:w-1/4">
                            <div class="text-xs text-gray-500 mb-1">æ¬„ä½åç¨±</div>
                            <input type="text" v-model="col.name" class="w-full border rounded p-1 text-sm font-mono" placeholder="column_name">
                        </div>

                        <template v-if="!(mode === 'alter' && alterType === 'DROP')">
                            <div class="w-full md:w-1/4">
                                <div class="text-xs text-gray-500 mb-1">å‹åˆ¥</div>
                                <select v-model="col.type" class="w-full border rounded p-1 text-sm">
                                    <option value="INT">INT / INTEGER</option>
                                    <option value="BIGINT">BIGINT</option>
                                    <option value="VARCHAR">VARCHAR</option>
                                    <option value="TEXT">TEXT</option>
                                    <option value="TIMESTAMP">TIMESTAMP / DATETIME</option>
                                    <option value="DATE">DATE</option>
                                    <option value="BOOLEAN">BOOLEAN</option>
                                    <option value="DECIMAL">DECIMAL</option>
                                    <option value="JSONB">JSONB (PG) / JSON</option>
                                </select>
                            </div>

                            <div class="w-1/2 md:w-1/6">
                                <div class="text-xs text-gray-500 mb-1">é•·åº¦</div>
                                <input type="text" v-model="col.length" :disabled="!needsLength(col.type)" class="w-full border rounded p-1 text-sm disabled:bg-gray-100" placeholder="e.g. 255">
                            </div>

                            <div class="w-1/2 md:w-1/3 flex items-center justify-around pt-5">
                                <label class="flex items-center space-x-1 cursor-pointer text-xs font-bold text-gray-600" :class="{'opacity-40': mode === 'alter'}">
                                    <input type="checkbox" v-model="col.pk" :disabled="mode === 'alter'"> <span>PK</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer text-xs font-bold text-gray-600" :class="{'opacity-40': mode === 'alter'}">
                                    <input type="checkbox" v-model="col.ai" :disabled="mode === 'alter'"> <span>AI</span>
                                </label>
                                
                                <label class="flex items-center space-x-1 cursor-pointer text-xs font-bold transition-colors"
                                    :class="isNullDisabled ? 'text-gray-300 cursor-not-allowed' : 'text-blue-600'">
                                    <input type="checkbox" v-model="col.notNull" :disabled="isNullDisabled"> <span>NN</span>
                                </label>
                            </div>
                        </template>
                        
                        <div v-else class="flex-grow flex items-center pt-5 px-4 text-red-500 text-sm font-bold">
                            âš ï¸ æ­¤æ¬„ä½å°‡è¢«ç§»é™¤
                        </div>

                        <div v-if="mode === 'create'" class="pt-5">
                            <button @click="removeColumn(index)" class="text-gray-400 hover:text-red-500 px-2">&times;</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="mode === 'alter'" class="bg-amber-50 p-5 rounded-lg shadow-sm border border-amber-200">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <h2 class="text-sm font-bold text-amber-700 uppercase tracking-wider mr-2">View ä¾è³´è™•ç†</h2>
                        <span class="text-xs text-amber-600 bg-amber-100 px-2 py-0.5 rounded-full">Drop -> Alter -> Recreate</span>
                    </div>
                    <button @click="addView" class="text-xs bg-amber-500 text-white px-3 py-1 rounded hover:bg-amber-600 shadow">
                        + åŠ å…¥å—å½±éŸ¿çš„ View
                    </button>
                </div>
                
                <div v-if="views.length === 0" class="text-center py-4 text-sm text-gray-400 italic border-2 border-dashed border-amber-200 rounded">
                    è‹¥æ­¤ä¿®æ”¹æœƒå½±éŸ¿ Viewï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•åŠ å…¥ View å®šç¾©ã€‚
                </div>

                <div class="space-y-4">
                    <div v-for="(view, idx) in views" :key="idx" class="bg-white p-4 rounded border border-amber-200 shadow-sm relative">
                        <button @click="removeView(idx)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 font-bold">&times;</button>
                        <div class="mb-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">View åç¨±</label>
                            <input type="text" v-model="view.name" class="w-full border border-gray-300 rounded p-1.5 text-sm font-mono" placeholder="view_name">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">View å®šç¾©</label>
                            <textarea v-model="view.definition" class="w-full border border-gray-300 rounded p-1.5 text-xs font-mono h-16 focus:ring-1 focus:ring-amber-500 outline-none" placeholder="SELECT ..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="xl:col-span-5">
            <div class="sticky top-6">
                <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden flex flex-col h-[calc(100vh-100px)]">
                    <div class="bg-gray-900 px-4 py-3 flex justify-between items-center border-b border-gray-700">
                        <div class="flex space-x-2">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        </div>
                        <div class="text-xs font-mono text-gray-400">SQL Output</div>
                        <button @click="copySQL" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 px-2 py-1 rounded transition">Copy</button>
                    </div>
                    <div class="flex-grow p-4 overflow-auto bg-[#1e1e1e]">
                        <div class="text-gray-300 sql-output" v-html="highlightedSQL"></div>
                    </div>
                    <div class="bg-gray-900 p-2 text-center text-xs text-gray-500">
                        {{ dbType === 'pgsql' ? 'PostgreSQL Mode' : 'MySQL Mode' }}
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                mode: 'alter',
                dbType: 'pgsql',
                alterType: 'MODIFY',
                tableName: 'users',
                updateNull: false, // ğŸŒŸ æ§åˆ¶æ˜¯å¦ä¿®æ”¹ Null å±¬æ€§
                columns: [
                    { name: 'email', type: 'VARCHAR', length: '255', pk: false, ai: false, notNull: true }
                ],
                views: []
            }
        },
        watch: {
            mode(newMode) {
                if (newMode === 'create') {
                    this.columns = [
                        { name: 'id', type: 'INT', length: '', pk: true, ai: true, notNull: true },
                        { name: 'name', type: 'VARCHAR', length: '100', pk: false, ai: false, notNull: false }
                    ];
                    this.views = [];
                } else {
                    this.columns = [{ name: 'target_col', type: 'VARCHAR', length: '100', pk: false, ai: false, notNull: false }];
                }
            }
        },
        computed: {
            // æ§åˆ¶ NN Checkbox æ˜¯å¦ç¦ç”¨
            isNullDisabled() {
                // å¦‚æœæ˜¯ Alter + Modify ä¸” æ²’æœ‰å‹¾é¸ updateNull -> ç¦ç”¨
                if (this.mode === 'alter' && this.alterType === 'MODIFY' && !this.updateNull) {
                    return true;
                }
                return false; // å…¶ä»–æƒ…æ³ (Create, Add Column) é è¨­å•Ÿç”¨
            },
            rawSQL() {
                if (!this.tableName) return '-- è«‹è¼¸å…¥ Table Name';
                return this.mode === 'create' ? this.buildCreateSQL() : this.buildAlterSQL();
            },
            highlightedSQL() {
                let sql = this.rawSQL.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const keywords = ['CREATE', 'TABLE', 'ALTER', 'DROP', 'VIEW', 'IF', 'EXISTS', 'COLUMN', 'TYPE', 'ADD', 'MODIFY', 'AS', 'SELECT', 'FROM', 'WHERE', 'PRIMARY', 'KEY', 'NOT', 'NULL', 'AUTO_INCREMENT', 'SERIAL', 'BIGSERIAL', 'CASCADE', 'BEGIN', 'COMMIT', 'SET', 'USING'];
                keywords.forEach(kw => {
                    sql = sql.replace(new RegExp(`\\b${kw}\\b`, 'g'), `<span class="text-purple-400 font-bold">${kw}</span>`);
                });
                sql = sql.replace(/(--.*)/g, '<span class="text-green-500 italic">$1</span>');
                sql = sql.replace(/('.*?')/g, '<span class="text-yellow-300">$1</span>');
                return sql;
            }
        },
        methods: {
            q(name) {
                if (!name) return '';
                const char = this.dbType === 'mysql' ? '`' : '"';
                return `${char}${name}${char}`;
            },
            needsLength(type) {
                return ['VARCHAR', 'CHAR', 'DECIMAL'].includes(type);
            },
            getRealType(col) {
                let type = col.type;
                if (this.dbType === 'pgsql') {
                    if (col.ai) return type === 'BIGINT' ? 'BIGSERIAL' : 'SERIAL';
                    if (type === 'DATETIME') return 'TIMESTAMP';
                    if (type === 'JSON') return 'JSONB';
                }
                if (this.dbType === 'mysql') {
                    if (type === 'TIMESTAMP') return 'DATETIME';
                    if (type === 'JSONB') return 'JSON';
                }
                return type;
            },
            addColumn() { this.columns.push({ name: '', type: 'VARCHAR', length: '255', pk: false, ai: false, notNull: false }); },
            removeColumn(idx) { this.columns.splice(idx, 1); },
            addView() { this.views.push({ name: '', definition: '' }); },
            removeView(idx) { this.views.splice(idx, 1); },

            buildColumnDef(col, isModify = false) {
                const realType = this.getRealType(col);
                let line = `  ${this.q(col.name)} ${realType}`;
                if (col.length && this.needsLength(col.type) && !col.ai) line += `(${col.length})`;
                
                // é‚è¼¯æ ¸å¿ƒï¼šæ˜¯å¦åŠ å…¥ NOT NULL
                // 1. Create / Add: ç¸½æ˜¯æ ¹æ“š checkbox
                // 2. Modify: åªæœ‰åœ¨ updateNull ç‚º true æ™‚æ‰åŠ å…¥ (PostgreSQL ç‰¹æ®Šè™•ç†åœ¨å¤–é¢ï¼Œé€™è£¡ä¸»è¦çµ¦ MySQL)
                // MySQL éœ€è¦åœ¨é€™è£¡å°±çµ¦å‡ºå®Œæ•´çš„å®šç¾©
                
                let shouldAddNullSql = true;
                if (this.mode === 'alter' && this.alterType === 'MODIFY' && this.dbType === 'pgsql') {
                    // PG çš„ modify æ˜¯åˆ†é–‹çš„ï¼Œæ‰€ä»¥é€™è£¡ buildColumnDef åªè² è²¬ Type éƒ¨åˆ†ï¼Œä¸åŠ  NN
                    shouldAddNullSql = false; 
                }

                if (shouldAddNullSql) {
                    if (col.notNull && !col.ai) line += ' NOT NULL';
                    if (this.dbType === 'mysql' && col.ai) line += ' AUTO_INCREMENT';
                }
                
                return line;
            },

            buildCreateSQL() {
                // (Create SQL é‚è¼¯ä¿æŒä¸è®Š)
                let sql = `CREATE TABLE ${this.q(this.tableName)} (\n`;
                let pkList = [];
                let colDefs = this.columns.map(col => {
                    if (!col.name) return null;
                    if (col.pk) pkList.push(col.name);
                    return this.buildColumnDef(col);
                }).filter(x => x);
                if (pkList.length > 0) colDefs.push(`  PRIMARY KEY (${pkList.map(k => this.q(k)).join(', ')})`);
                sql += colDefs.join(',\n') + `\n);`;
                return sql;
            },

            buildAlterSQL() {
                const col = this.columns[0];
                if (!col || !col.name) return '-- è«‹è¼¸å…¥æ¬„ä½åç¨±';
                const tbl = this.q(this.tableName);
                const colName = this.q(col.name);
                let mainSql = '';

                if (this.alterType === 'ADD') {
                    mainSql = `ALTER TABLE ${tbl} ADD COLUMN ${this.buildColumnDef(col).trim()};`;
                } else if (this.alterType === 'DROP') {
                    mainSql = `ALTER TABLE ${tbl} DROP COLUMN ${colName};`;
                } else if (this.alterType === 'MODIFY') {
                    if (this.dbType === 'mysql') {
                        // MySQL: MODIFY éœ€è¦å®Œæ•´å®šç¾©
                        // æ³¨æ„ï¼šå¦‚æœ updateNull ç‚º falseï¼Œé€™è£¡ç”¢ç”Ÿçš„ SQL è‹¥æ²’æœ‰ NOT NULLï¼ŒMySQL æœƒè¦–ç‚º NULL
                        // ä½†é€™æ˜¯ MySQL èªæ³•é™åˆ¶ï¼Œç„¡æ³•åƒ PG é‚£æ¨£ "åªæ”¹ Type ä¸æ”¹ Null" (é™¤éå…ˆ query åŸæœ¬ schemaï¼Œå‰ç«¯åšä¸åˆ°)
                        mainSql = `ALTER TABLE ${tbl} MODIFY COLUMN ${this.buildColumnDef(col).trim()};`;
                    } else {
                        // PostgreSQL: ALTER TYPE
                        // 1. åªæ”¹ Type
                        let realType = this.getRealType(col);
                        if (col.length && this.needsLength(col.type)) realType += `(${col.length})`;
                        const usingClause = ` USING ${colName}::${realType.split('(')[0]}`; 
                        
                        mainSql = `ALTER TABLE ${tbl} ALTER COLUMN ${colName} TYPE ${realType}${usingClause};`;
                        
                        // 2. åªæœ‰ç•¶ä½¿ç”¨è€…å‹¾é¸ã€ŒåŒæ™‚ä¿®æ”¹ Null å±¬æ€§ã€æ™‚ï¼Œæ‰ç”¢ç”Ÿé€™ä¸€è¡Œ
                        if (this.updateNull) {
                             if (col.notNull) {
                                 mainSql += `\nALTER TABLE ${tbl} ALTER COLUMN ${colName} SET NOT NULL;`;
                             } else {
                                 mainSql += `\nALTER TABLE ${tbl} ALTER COLUMN ${colName} DROP NOT NULL;`;
                             }
                        }
                    }
                }

                if (this.views.length === 0) return mainSql;

                let fullSql = '';
                if (this.dbType === 'pgsql') fullSql += 'BEGIN;\n\n';
                fullSql += `-- 1. Drop Dependent Views\n`;
                this.views.forEach(v => {
                    fullSql += `DROP VIEW IF EXISTS ${v.name ? this.q(v.name) : 'view_name'} CASCADE;\n`;
                });
                fullSql += `\n-- 2. Modify Table\n${mainSql}\n`;
                fullSql += `\n-- 3. Recreate Views\n`;
                this.views.forEach(v => {
                    fullSql += `CREATE VIEW ${v.name ? this.q(v.name) : 'view_name'} AS\n${v.definition || '-- SELECT ...'};\n`;
                });
                if (this.dbType === 'pgsql') fullSql += '\nCOMMIT;';
                return fullSql;
            },
            copySQL() { navigator.clipboard.writeText(this.rawSQL).then(() => alert('Copied!')); }
        }
    }).mount('#app');
</script>

</body>
</html>