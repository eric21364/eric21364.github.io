<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Schema Designer (Table + View + Index)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .sql-output { font-family: 'Consolas', 'Monaco', monospace; white-space: pre; font-size: 13px; line-height: 1.5; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body>

<div id="app" class="container mx-auto p-4 max-w-7xl">
    
    <div class="mb-6 flex justify-between items-end border-b pb-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">ğŸ› ï¸ SQL Schema Designer <span class="text-sm font-normal text-slate-500 ml-2">v4.0</span></h1>
            <p class="text-slate-500 text-sm mt-1">Columns â€¢ Indexes â€¢ Unique Constraints â€¢ Views ä¾è³´è™•ç†</p>
        </div>
        <div class="flex bg-gray-200 p-1 rounded-lg">
            <button @click="setMode('create')" :class="mode === 'create' ? 'bg-white shadow text-blue-600' : 'text-gray-600'" class="px-4 py-2 rounded-md font-bold transition">å»ºç«‹ (Create)</button>
            <button @click="setMode('alter')" :class="mode === 'alter' ? 'bg-white shadow text-purple-600' : 'text-gray-600'" class="px-4 py-2 rounded-md font-bold transition">ä¿®æ”¹ (Alter)</button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
        
        <div class="xl:col-span-7 space-y-6">
            
            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">è³‡æ–™åº«é¡å‹</label>
                        <select v-model="dbType" class="w-full border-gray-300 border rounded-md p-2 bg-slate-50 focus:ring-2 focus:ring-blue-500">
                            <option value="pgsql">PostgreSQL</option>
                            <option value="mysql">MySQL / MariaDB</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Table Name</label>
                        <input type="text" v-model="tableName" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-blue-500" placeholder="e.g. users">
                    </div>
                </div>

                <div v-if="mode === 'alter'" class="mt-4 pt-4 border-t border-gray-100">
                    <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">æ“ä½œé¡å‹</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center cursor-pointer bg-slate-100 px-3 py-1.5 rounded hover:bg-slate-200">
                            <input type="radio" v-model="alterType" value="ADD" class="mr-2"> <span class="text-sm">æ–°å¢æ¬„ä½</span>
                        </label>
                        <label class="flex items-center cursor-pointer bg-slate-100 px-3 py-1.5 rounded hover:bg-slate-200">
                            <input type="radio" v-model="alterType" value="MODIFY" class="mr-2"> <span class="text-sm">ä¿®æ”¹æ¬„ä½</span>
                        </label>
                        <label class="flex items-center cursor-pointer bg-slate-100 px-3 py-1.5 rounded hover:bg-slate-200">
                            <input type="radio" v-model="alterType" value="DROP" class="mr-2"> <span class="text-sm text-red-600">åˆªé™¤æ¬„ä½</span>
                        </label>
                        
                        <div class="w-px h-8 bg-gray-300 mx-1"></div>

                        <label class="flex items-center cursor-pointer bg-indigo-50 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-100">
                            <input type="radio" v-model="alterType" value="ADD_INDEX" class="mr-2"> <span class="text-sm font-bold text-indigo-700">Add Index/UQ</span>
                        </label>
                        <label class="flex items-center cursor-pointer bg-indigo-50 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-100">
                            <input type="radio" v-model="alterType" value="DROP_INDEX" class="mr-2"> <span class="text-sm font-bold text-red-600">Drop Index/UQ</span>
                        </label>
                    </div>

                    <div v-if="alterType === 'MODIFY'" class="mt-3 flex items-center">
                        <label class="flex items-center cursor-pointer text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                            <input type="checkbox" v-model="updateNull" class="mr-1"> åŒæ™‚æ›´æ–° Null å±¬æ€§
                        </label>
                    </div>
                </div>
            </div>

            <div v-if="showColumnSection" class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 transition-all">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider">
                        {{ mode === 'create' ? 'æ¬„ä½å®šç¾©' : 'ç›®æ¨™æ¬„ä½' }}
                    </h2>
                    <button v-if="mode === 'create'" @click="addColumn" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 font-bold">
                        + æ–°å¢æ¬„ä½
                    </button>
                </div>

                <div class="space-y-3">
                    <div v-for="(col, index) in columns" :key="index" class="flex flex-wrap md:flex-nowrap gap-2 items-start bg-slate-50 p-3 rounded border border-slate-200">
                        <div class="w-full md:w-1/4">
                            <div class="text-xs text-gray-500 mb-1">æ¬„ä½åç¨±</div>
                            <input type="text" v-model="col.name" class="w-full border rounded p-1 text-sm font-mono" placeholder="column_name">
                        </div>

                        <template v-if="alterType !== 'DROP'">
                            <div class="w-full md:w-1/4">
                                <div class="text-xs text-gray-500 mb-1">å‹åˆ¥</div>
                                <select v-model="col.type" class="w-full border rounded p-1 text-sm">
                                    <option value="INT">INT / INTEGER</option>
                                    <option value="BIGINT">BIGINT</option>
                                    <option value="VARCHAR">VARCHAR</option>
                                    <option value="TEXT">TEXT</option>
                                    <option value="TIMESTAMP">TIMESTAMP / DATETIME</option>
                                    <option value="DATE">DATE</option>
                                    <option value="BOOLEAN">BOOLEAN</option>
                                    <option value="DECIMAL">DECIMAL</option>
                                    <option value="JSONB">JSONB/JSON</option>
                                </select>
                            </div>
                            <div class="w-1/2 md:w-1/6">
                                <div class="text-xs text-gray-500 mb-1">é•·åº¦</div>
                                <input type="text" v-model="col.length" :disabled="!needsLength(col.type)" class="w-full border rounded p-1 text-sm disabled:bg-gray-100" placeholder="255">
                            </div>
                            <div class="w-1/2 md:w-1/3 flex items-center justify-around pt-5">
                                <label class="flex items-center space-x-1 cursor-pointer text-xs font-bold text-gray-600" :class="{'opacity-40': mode === 'alter'}">
                                    <input type="checkbox" v-model="col.pk" :disabled="mode === 'alter'"> <span>PK</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer text-xs font-bold text-gray-600" :class="{'opacity-40': mode === 'alter'}">
                                    <input type="checkbox" v-model="col.ai" :disabled="mode === 'alter'"> <span>AI</span>
                                </label>
                                <label class="flex items-center space-x-1 cursor-pointer text-xs font-bold" :class="isNullDisabled ? 'text-gray-300' : 'text-blue-600'">
                                    <input type="checkbox" v-model="col.notNull" :disabled="isNullDisabled"> <span>NN</span>
                                </label>
                            </div>
                        </template>
                        <div v-else class="flex-grow flex items-center pt-5 px-4 text-red-500 text-sm font-bold">âš ï¸ å³å°‡åˆªé™¤æ­¤æ¬„ä½</div>
                        <div v-if="mode === 'create'" class="pt-5">
                            <button @click="removeColumn(index)" class="text-gray-400 hover:text-red-500 px-2">&times;</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showIndexSection" class="bg-indigo-50 p-5 rounded-lg shadow-sm border border-indigo-200 transition-all">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-bold text-indigo-700 uppercase tracking-wider">
                        ç´¢å¼•èˆ‡ç´„æŸ (Indexes & UQ)
                    </h2>
                    <button @click="addIndex" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 shadow">
                        + æ–°å¢ç´¢å¼•
                    </button>
                </div>

                <div v-if="indexes.length === 0" class="text-center py-4 text-xs text-gray-400 italic">
                    å°šæœªå®šç¾©ç´¢å¼• (Optional)
                </div>

                <div class="space-y-3">
                    <div v-for="(idx, index) in indexes" :key="index" class="flex flex-wrap md:flex-nowrap gap-2 items-start bg-white p-3 rounded border border-indigo-100 shadow-sm relative">
                        <button @click="removeIndex(index)" class="absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-red-200">&times;</button>
                        
                        <div class="w-1/4">
                            <div class="text-xs text-gray-500 mb-1">é¡å‹</div>
                            <select v-model="idx.type" class="w-full border border-gray-300 rounded p-1 text-sm font-bold text-gray-700">
                                <option value="INDEX">INDEX (ä¸€èˆ¬)</option>
                                <option value="UNIQUE">UNIQUE (å”¯ä¸€)</option>
                            </select>
                        </div>

                        <div class="w-1/3">
                            <div class="text-xs text-gray-500 mb-1">ç´¢å¼•åç¨± (Optional)</div>
                            <input type="text" v-model="idx.name" class="w-full border border-gray-300 rounded p-1 text-sm font-mono placeholder-gray-300" :placeholder="generateIndexName(idx) || 'idx_name'">
                        </div>

                        <div class="w-full md:flex-grow">
                            <div class="text-xs text-gray-500 mb-1">
                                {{ alterType === 'DROP_INDEX' ? 'éœ€æ³¨æ„ï¼šåˆªé™¤æ™‚åƒ…éœ€åç¨±' : 'æ¬„ä½ (é€—è™Ÿåˆ†éš”)' }}
                            </div>
                            <input type="text" v-model="idx.cols" :disabled="alterType === 'DROP_INDEX'" class="w-full border border-gray-300 rounded p-1 text-sm font-mono" placeholder="col1, col2">
                        </div>
                    </div>
                </div>
                
                <div v-if="alterType === 'DROP_INDEX'" class="mt-2 text-xs text-red-500 font-medium">
                    * åˆªé™¤ç´¢å¼•/ç´„æŸæ™‚ï¼Œè«‹ç¢ºä¿ã€Œç´¢å¼•åç¨±ã€æ­£ç¢ºã€‚PostgreSQL åˆªé™¤ UNIQUE éœ€ä½¿ç”¨ Drop Constraintã€‚
                </div>
            </div>

            <div v-if="mode === 'alter'" class="bg-amber-50 p-5 rounded-lg shadow-sm border border-amber-200">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-bold text-amber-700 uppercase tracking-wider flex items-center">
                        View ä¾è³´è™•ç† <span class="ml-2 text-[10px] bg-amber-200 text-amber-800 px-1 rounded">Drop & Recreate</span>
                    </h2>
                    <button @click="addView" class="text-xs bg-amber-500 text-white px-2 py-1 rounded hover:bg-amber-600 shadow">
                        + View
                    </button>
                </div>
                <div class="space-y-2">
                    <div v-for="(view, idx) in views" :key="idx" class="bg-white p-2 rounded border border-amber-200 shadow-sm relative grid grid-cols-1 md:grid-cols-3 gap-2">
                        <button @click="removeView(idx)" class="absolute top-1 right-1 text-gray-300 hover:text-red-500 font-bold leading-none">&times;</button>
                        <input type="text" v-model="view.name" class="border rounded p-1 text-xs font-mono" placeholder="view_name">
                        <textarea v-model="view.definition" class="md:col-span-2 border rounded p-1 text-xs font-mono h-8 focus:h-20 transition-all resize-none" placeholder="SELECT ..."></textarea>
                    </div>
                </div>
            </div>

        </div>

        <div class="xl:col-span-5">
            <div class="sticky top-6">
                <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden flex flex-col h-[calc(100vh-100px)]">
                    <div class="bg-gray-900 px-4 py-3 flex justify-between items-center border-b border-gray-700">
                        <div class="text-xs font-mono text-gray-400">SQL Output</div>
                        <button @click="copySQL" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 px-2 py-1 rounded transition">Copy</button>
                    </div>
                    <div class="flex-grow p-4 overflow-auto bg-[#1e1e1e]">
                        <div class="text-gray-300 sql-output" v-html="highlightedSQL"></div>
                    </div>
                    <div class="bg-gray-900 p-2 text-center text-xs text-gray-500">
                        {{ dbType === 'pgsql' ? 'PostgreSQL' : 'MySQL' }} Mode
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                mode: 'create', // create | alter
                dbType: 'pgsql',
                alterType: 'ADD', // ADD, MODIFY, DROP, ADD_INDEX, DROP_INDEX
                tableName: 'users',
                updateNull: false,
                columns: [
                    { name: 'id', type: 'INT', length: '', pk: true, ai: true, notNull: true },
                    { name: 'email', type: 'VARCHAR', length: '100', pk: false, ai: false, notNull: true }
                ],
                indexes: [
                     { name: '', type: 'UNIQUE', cols: 'email' } // ç¯„ä¾‹
                ],
                views: []
            }
        },
        watch: {
            // åˆ‡æ›æ¨¡å¼æ™‚é‡ç½®éƒ¨åˆ†æ•¸æ“šï¼Œé¿å…æ··äº‚
            mode(newVal) {
                if (newVal === 'alter') {
                    this.columns = [{ name: 'new_col', type: 'VARCHAR', length: '50', pk: false, ai: false, notNull: false }];
                    this.indexes = [];
                } else {
                    this.columns = [
                        { name: 'id', type: 'INT', length: '', pk: true, ai: true, notNull: true },
                        { name: 'email', type: 'VARCHAR', length: '100', pk: false, ai: false, notNull: true }
                    ];
                    this.indexes = [{ name: '', type: 'UNIQUE', cols: 'email' }];
                }
            }
        },
        computed: {
            showColumnSection() {
                // åœ¨ Create æ¨¡å¼ç¸½æ˜¯é¡¯ç¤º
                if (this.mode === 'create') return true;
                // åœ¨ Alter æ¨¡å¼ï¼Œåªæœ‰ç•¶æ“ä½œä¸æ˜¯ Index ç›¸é—œæ™‚æ‰é¡¯ç¤º
                return !['ADD_INDEX', 'DROP_INDEX'].includes(this.alterType);
            },
            showIndexSection() {
                // åœ¨ Create æ¨¡å¼ç¸½æ˜¯é¡¯ç¤º
                if (this.mode === 'create') return true;
                // åœ¨ Alter æ¨¡å¼ï¼Œåªæœ‰ç•¶æ“ä½œæ˜¯ Index ç›¸é—œæ™‚æ‰é¡¯ç¤º
                return ['ADD_INDEX', 'DROP_INDEX'].includes(this.alterType);
            },
            isNullDisabled() {
                return (this.mode === 'alter' && this.alterType === 'MODIFY' && !this.updateNull);
            },
            rawSQL() {
                if (!this.tableName) return '-- Please enter Table Name';
                return this.mode === 'create' ? this.buildCreateSQL() : this.buildAlterSQL();
            },
            highlightedSQL() {
                let sql = this.rawSQL.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const keywords = ['CREATE', 'TABLE', 'ALTER', 'DROP', 'VIEW', 'INDEX', 'UNIQUE', 'CONSTRAINT', 'IF', 'EXISTS', 'COLUMN', 'TYPE', 'ADD', 'MODIFY', 'AS', 'SELECT', 'FROM', 'WHERE', 'PRIMARY', 'KEY', 'NOT', 'NULL', 'AUTO_INCREMENT', 'SERIAL', 'BIGSERIAL', 'CASCADE', 'BEGIN', 'COMMIT', 'SET', 'USING', 'ON'];
                keywords.forEach(kw => {
                    sql = sql.replace(new RegExp(`\\b${kw}\\b`, 'g'), `<span class="text-purple-400 font-bold">${kw}</span>`);
                });
                sql = sql.replace(/(--.*)/g, '<span class="text-green-500 italic">$1</span>');
                sql = sql.replace(/('.*?')/g, '<span class="text-yellow-300">$1</span>');
                return sql;
            }
        },
        methods: {
            setMode(m) { this.mode = m; },
            q(name) {
                if (!name) return '';
                const char = this.dbType === 'mysql' ? '`' : '"';
                return `${char}${name}${char}`;
            },
            needsLength(type) { return ['VARCHAR', 'CHAR', 'DECIMAL'].includes(type); },
            getRealType(col) {
                let type = col.type;
                if (this.dbType === 'pgsql') {
                    if (col.ai) return type === 'BIGINT' ? 'BIGSERIAL' : 'SERIAL';
                    if (type === 'DATETIME') return 'TIMESTAMP';
                    if (type === 'JSON') return 'JSONB';
                }
                if (this.dbType === 'mysql') {
                    if (type === 'TIMESTAMP') return 'DATETIME';
                    if (type === 'JSONB') return 'JSON';
                }
                return type;
            },
            // Column CRUD
            addColumn() { this.columns.push({ name: '', type: 'VARCHAR', length: '255', pk: false, ai: false, notNull: false }); },
            removeColumn(idx) { this.columns.splice(idx, 1); },
            // Index CRUD
            addIndex() { this.indexes.push({ name: '', type: 'INDEX', cols: '' }); },
            removeIndex(idx) { this.indexes.splice(idx, 1); },
            generateIndexName(idx) {
                if(idx.name) return idx.name;
                // è‡ªå‹•ç”¢ç”Ÿå»ºè­°åç¨±
                const prefix = idx.type === 'UNIQUE' ? 'uq' : 'idx';
                const colPart = idx.cols ? idx.cols.replace(/,\s*/g, '_').replace(/[^a-zA-Z0-9_]/g, '') : 'cols';
                return `${prefix}_${this.tableName}_${colPart}`;
            },
            // View CRUD
            addView() { this.views.push({ name: '', definition: '' }); },
            removeView(idx) { this.views.splice(idx, 1); },

            // SQL Builders
            buildColumnDef(col) {
                const realType = this.getRealType(col);
                let line = `  ${this.q(col.name)} ${realType}`;
                if (col.length && this.needsLength(col.type) && !col.ai) line += `(${col.length})`;
                
                let shouldAddNull = true;
                if (this.mode === 'alter' && this.alterType === 'MODIFY' && this.dbType === 'pgsql') shouldAddNull = false;

                if (shouldAddNull) {
                    if (col.notNull && !col.ai) line += ' NOT NULL';
                    if (this.dbType === 'mysql' && col.ai) line += ' AUTO_INCREMENT';
                }
                return line;
            },

            buildCreateSQL() {
                let sql = `CREATE TABLE ${this.q(this.tableName)} (\n`;
                let pkList = [];
                let lines = [];
                
                // 1. Columns
                this.columns.forEach(col => {
                    if(col.name) {
                        if(col.pk) pkList.push(col.name);
                        lines.push(this.buildColumnDef(col));
                    }
                });

                // 2. PK
                if (pkList.length > 0) {
                    lines.push(`  PRIMARY KEY (${pkList.map(k => this.q(k)).join(', ')})`);
                }

                // 3. Inline Indexes / Constraints
                let postCreateSQL = ''; // For PG Indexes that must be outside
                
                this.indexes.forEach(idx => {
                    if(!idx.cols) return;
                    const idxName = idx.name || this.generateIndexName(idx);
                    const colsFormatted = idx.cols.split(',').map(c => this.q(c.trim())).join(', ');

                    if (this.dbType === 'mysql') {
                        // MySQL: All inside
                        if (idx.type === 'UNIQUE') {
                            lines.push(`  UNIQUE KEY ${this.q(idxName)} (${colsFormatted})`);
                        } else {
                            lines.push(`  KEY ${this.q(idxName)} (${colsFormatted})`);
                        }
                    } else {
                        // PostgreSQL: UNIQUE inside (constraint), INDEX outside
                        if (idx.type === 'UNIQUE') {
                            lines.push(`  CONSTRAINT ${this.q(idxName)} UNIQUE (${colsFormatted})`);
                        } else {
                            postCreateSQL += `CREATE INDEX ${this.q(idxName)} ON ${this.q(this.tableName)} (${colsFormatted});\n`;
                        }
                    }
                });

                sql += lines.join(',\n');
                sql += `\n);`;
                
                if (postCreateSQL) sql += '\n\n' + postCreateSQL;
                
                return sql;
            },

            buildAlterSQL() {
                const tbl = this.q(this.tableName);
                let mainSql = '';

                // Handle Index Operations
                if (['ADD_INDEX', 'DROP_INDEX'].includes(this.alterType)) {
                    let statements = [];
                    this.indexes.forEach(idx => {
                        const idxName = idx.name || this.generateIndexName(idx);
                        
                        if (this.alterType === 'ADD_INDEX') {
                            if (!idx.cols) return;
                            const colsFormatted = idx.cols.split(',').map(c => this.q(c.trim())).join(', ');
                            
                            if (this.dbType === 'mysql') {
                                const keyType = idx.type === 'UNIQUE' ? 'UNIQUE INDEX' : 'INDEX';
                                statements.push(`ALTER TABLE ${tbl} ADD ${keyType} ${this.q(idxName)} (${colsFormatted});`);
                            } else {
                                // PG
                                if (idx.type === 'UNIQUE') {
                                    statements.push(`ALTER TABLE ${tbl} ADD CONSTRAINT ${this.q(idxName)} UNIQUE (${colsFormatted});`);
                                } else {
                                    statements.push(`CREATE INDEX ${this.q(idxName)} ON ${tbl} (${colsFormatted});`);
                                }
                            }
                        } else {
                            // DROP_INDEX
                            if (!idxName && !idx.name) return; // Need name
                            const realName = idx.name || 'unknown_idx';
                            
                            if (this.dbType === 'mysql') {
                                statements.push(`DROP INDEX ${this.q(realName)} ON ${tbl};`);
                            } else {
                                // PG: Need to know if it's constraint or index
                                if (idx.type === 'UNIQUE') {
                                    statements.push(`ALTER TABLE ${tbl} DROP CONSTRAINT ${this.q(realName)};`);
                                } else {
                                    statements.push(`DROP INDEX ${this.q(realName)};`);
                                }
                            }
                        }
                    });
                    mainSql = statements.join('\n');
                } 
                // Handle Column Operations (ADD, MODIFY, DROP)
                else {
                    const col = this.columns[0];
                    if (!col || !col.name) return '-- è«‹è¼¸å…¥æ¬„ä½åç¨±';
                    const colName = this.q(col.name);

                    if (this.alterType === 'ADD') {
                        mainSql = `ALTER TABLE ${tbl} ADD COLUMN ${this.buildColumnDef(col).trim()};`;
                    } else if (this.alterType === 'DROP') {
                        mainSql = `ALTER TABLE ${tbl} DROP COLUMN ${colName};`;
                    } else if (this.alterType === 'MODIFY') {
                        if (this.dbType === 'mysql') {
                            mainSql = `ALTER TABLE ${tbl} MODIFY COLUMN ${this.buildColumnDef(col).trim()};`;
                        } else {
                            // PG
                            let realType = this.getRealType(col);
                            if (col.length && this.needsLength(col.type)) realType += `(${col.length})`;
                            mainSql = `ALTER TABLE ${tbl} ALTER COLUMN ${colName} TYPE ${realType} USING ${colName}::${realType.split('(')[0]};`;
                            
                            if (this.updateNull) {
                                mainSql += `\nALTER TABLE ${tbl} ALTER COLUMN ${colName} ${col.notNull ? 'SET' : 'DROP'} NOT NULL;`;
                            }
                        }
                    }
                }

                // View Logic Wrapper
                if (this.views.length === 0) return mainSql || '-- No changes generated';

                let fullSql = '';
                if (this.dbType === 'pgsql') fullSql += 'BEGIN;\n\n';
                fullSql += `-- 1. Drop Dependent Views\n`;
                this.views.forEach(v => {
                    fullSql += `DROP VIEW IF EXISTS ${v.name ? this.q(v.name) : 'view_name'} CASCADE;\n`;
                });
                fullSql += `\n-- 2. Apply Changes\n${mainSql}\n`;
                fullSql += `\n-- 3. Recreate Views\n`;
                this.views.forEach(v => {
                    fullSql += `CREATE VIEW ${v.name ? this.q(v.name) : 'view_name'} AS\n${v.definition || '-- SELECT ...'};\n`;
                });
                if (this.dbType === 'pgsql') fullSql += '\nCOMMIT;';
                
                return fullSql;
            },
            copySQL() { navigator.clipboard.writeText(this.rawSQL).then(() => alert('Copied!')); }
        }
    }).mount('#app');
</script>

</body>
</html>